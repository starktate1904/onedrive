{% block pageContent %}

<!-- Container for the POS system -->
<div class="container">
    <div class="row">
        <!-- Left column for searching products -->
        <div class="col-md-6">
            <h2>Search Products</h2>
            <!-- Search bar for products -->
            <input type="text" id="search-product" placeholder="Search product">
            <!-- List of searched products -->
            <div id="product-list"></div>
            <!-- Table for selected products -->
            <table id="selected-products" class="table table-striped">
                <thead>
                    <tr>
                        <th>Product</th>
                        <th>Quantity</th>
                        <th>Delete</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </div>
        <!-- Right column for sale details -->
        <div class="col-md-6">
            <h2>Sale Details</h2>
            <!-- Form for sale details -->
            <div>
                <h2>Sale Details</h2>
                <p>Unit Price: <input type="text" id="unit-price" readonly></p>
                <p>Total Amount: <input type="text" id="total-amount" readonly></p>
                <p>Amount Tendered: <input type="number" id="amount-tendered"></p>
                <p>Change: <input type="text" id="change" readonly></p>
            </div>
        </div>
    </div>
</div>

<!-- Modal for sale success message -->
<div class="modal fade" id="sale-success-modal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Sale Successful!</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Sale successful! Products updated.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function() {
        // Search product



                    // Add product to sale
            $(document).on('click', '.add-product-btn', function() {
                // Your existing code here
                updateSaleDetails();
            });

            // Delete product from sale
            $(document).on('click', '.delete-product-btn', function() {
                // Your existing code here
                updateSaleDetails();
            });

            // Update quantity
            $(document).on('change', '.quantity', function() {
                updateSaleDetails();
            });

            // Update amount tendered
            $(document).on('change', '#amount-tendered', function() {
                updateSaleDetails();
            });





        $('#search-product').keyup(function() {
            var query = $(this).val();
            $.ajax({
                type: 'GET',
                url: "{% url 'sales:search-products' %}",
                data: { query: query },
                success: function(data) {
                    if (data.products) {
                        $('#product-list').html('');
                        $.each(data.products, function(index, product) {
                            $('#product-list').append(`
                                <div>
                                    <p>` + product.name + `</p>
                                    <button class="add-product-btn" data-product-id="` + product.id + `">Add to Sale</button>
                                </div>
                            `);
                        });
                    } else {
                        $('#product-list').html('<p>No products found.</p>');
                    }
                }
            });
        });


                // Add product to sale
        $(document).on('click', '.add-product-btn', function() {
            var productId = $(this).data('product-id');
            var productName = $(this).closest('div').find('p').text();
            var quantity = 1;
            
            // Check if product is already in the sale
            var existingProduct = $('#selected-products tbody tr').find('td:contains("' + productName + '")');
            if (existingProduct.length > 0) {
                var existingQuantity = existingProduct.closest('tr').find('.quantity').val();
                existingQuantity = parseInt(existingQuantity) + 1;
                existingProduct.closest('tr').find('.quantity').val(existingQuantity);
            } else {
                // Add product to sale
                $('#selected-products tbody').append(`
                    <tr>
                        <td>` + productName + `</td>
                        <td><input type="number" class="quantity" value="` + quantity + `"></td>
                        <td><button class="delete-product-btn" data-product-id="` + productId + `">Delete</button></td>
                    </tr>
                `);
            }
            
            updateSaleDetails();
        })

        // Add product to sale
        $(document).on('click', '.add-product-btn', function() {
            var productId = $(this).data('product-id');
            $.ajax({
                type: 'GET',
                url: "{% url 'sales:get_products' %}",
                data: { id: productId },
                success: function(data) {
                    $('#selected-products tbody').append(`
                        <tr>
                            <td>` + data.product.name + `</td>
                            <td><input type="number" class="quantity" value="1"></td>
                            <td><button class="delete-product-btn" data-product-id="` + productId + `">Delete</button></td>
                        </tr>
                    `);
                }
            });
        });

        // Delete product from sale
        $(document).on('click', '.delete-product-btn', function() {
            $(this).closest('tr').remove();
            updateSaleDetails();
        });

        // Update quantity
        $(document).on('change', '.quantity', function() {
            updateSaleDetails();
        });


// Update sale details
function updateSaleDetails() {
    var subtotal = 0;
    var total = 0;
    var change = 0;
    var amountTendered = parseFloat($('#amount-tendered').val());
    var unitPrice = 0;

    $('#selected-products tbody tr').each(function() {
        var quantity = $(this).find('.quantity').val();
        var price = $(this).find('.price').text().replace('$', ''); // Remove the dollar sign
        price = parseFloat(price); // Convert the price to a number
        unitPrice = price; // Set the unit price to the original price of the product
        subtotal += parseInt(quantity) * price;
    });

    total = subtotal 

    if (amountTendered > 0) {
        change = amountTendered - total;
    }

    $('#unit-price').val(unitPrice.toFixed(2));
    $('#total-amount').val(total.toFixed(2));
    $('#change').val(change.toFixed(2));
}





     
            // Checkout button click
        $('#checkout-btn').click(function() {
            var products = [];
            $('#selected-products tbody tr').each(function() {
                var productId = $(this).find('.delete-product-btn').data('product-id');
                var quantity = $(this).find('.quantity').val();
                products.push({ id: productId, quantity: quantity });
            });

            var csrfToken = "{{ csrf_token }}";
            $.ajax({
                type: 'POST',
                url: "{% url 'sales:create_sale' %}",
                data: JSON.stringify({ products: products }),
                contentType: "application/json",
                headers: {
                    "X-CSRFToken": csrfToken
                },
                success: function(data) {
                    $('#sale-success-modal').modal('show');
                $.ajax({
    type: 'POST',
    url: "{% url 'sales:create_sale' %}",
    data: JSON.stringify({ products: products }),
    contentType: "application/json",
    headers: {
        "X-CSRFToken": csrfToken
    },
    success: function(data) {
        $('#sale-success-modal').modal('show');
    },
    error: function(xhr, status, error) {
        console.log(xhr.responseText);
        console.log(status);
        console.log(error);
    }
});

                }
            });
        });
    });
</script>
{% endblock %}